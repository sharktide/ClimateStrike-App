@using STRIKE
@using STRIKE.Inference

<MudPaper Elevation="3" Class="pa-4">
    <MudGrid>
        <MudItem xs="12" sm="6">
            <MudSlider T="float" Min="0.5f" Max="25.0f" Step="0.1f" @bind-Value="_momentRate"
                       Variant="Variant.Filled" Color="Color.Success" ValueLabel="true">
                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                    <MudText>Seismic Moment Rate:</MudText>
                    <MudText Color="Color.Primary">@_momentRate.ToString("0.00")</MudText>
                    <MudSelect T="string" Dense="true" @bind-Value="_1" Class="ml-2" Style="width: 80px;">
                            <MudSelectItem Value="@("1")"><MudText Color="Color.Primary">×10¹⁶ Nm/s</MudText></MudSelectItem>
                    </MudSelect>
                </MudStack>
            </MudSlider>
            <MudSlider T="float" Min="0f" Max="100f" Step="1f" @bind-Value="_displacementRate"
                       Variant="Variant.Filled" Color="Color.Success" ValueLabel="true">
                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                    <MudText>Surface Displacement Rate:</MudText>
                    <MudText Color="Color.Primary">@_displacementRate.ToString()</MudText>
                    <MudSelect T="string" Dense="true" @bind-Value="_2" Class="ml-2" Style="width: 80px;">
                            <MudSelectItem Value="@("2")"><MudText Color="Color.Primary">mm/yr</MudText></MudSelectItem>
                    </MudSelect>
                </MudStack>
            </MudSlider>
            <MudSlider T="float" Min="0f" Max="700f" Step="1f" @bind-Value="_stressChange"
                       Variant="Variant.Filled" Color="Color.Success" ValueLabel="true">
                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                    <MudText>Coulomb Stress Change:</MudText>
                    <MudText Color="Color.Primary">@_stressChange.ToString()</MudText>
                    <MudSelect T="string" Dense="true" @bind-Value="_3" Class="ml-2" Style="width: 80px;">
                            <MudSelectItem Value="@("3")"><MudText Color="Color.Primary">Pa</MudText></MudSelectItem>
                    </MudSelect>
                </MudStack>
            </MudSlider>
            <MudSlider T="float" Min="0f" Max="60f" Step="1f" @bind-Value="_focalDepth"
                       Variant="Variant.Filled" Color="Color.Success" ValueLabel="true">
                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                    <MudText>Average Focal Depth:</MudText>
                    <MudText Color="Color.Primary">@_focalDepth.ToString()</MudText>
                    <MudSelect T="string" Dense="true" @bind-Value="_4" Class="ml-2" Style="width: 80px;">
                            <MudSelectItem Value="@("4")"><MudText Color="Color.Primary">km</MudText></MudSelectItem>
                    </MudSelect>
                </MudStack>
            </MudSlider>
            <MudSlider T="float" Min="0f" Max="20f" Step="0.1f" @bind-Value="_slipRate"
                       Variant="Variant.Filled" Color="Color.Success" ValueLabel="true">
                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                    <MudText>Fault Slip Rate:</MudText>
                    <MudText Color="Color.Primary">@_slipRate.ToString("0.00")</MudText>
                    <MudSelect T="string" Dense="true" @bind-Value="_5" Class="ml-2" Style="width: 80px;">
                            <MudSelectItem Value="@("5")"><MudText Color="Color.Primary">mm/yr</MudText></MudSelectItem>
                    </MudSelect>
                </MudStack>
            </MudSlider>
            <MudStack Row="false" Spacing="2" Class="mt-4">
                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                    <MudCheckBox @bind-Value="_useTrust" T="bool" Label="Use EarthquakeTrustNet" Color="Color.Primary" />
                    
                    <MudCheckBox @bind-Value="_useInternet"
                                T="bool"
                                Label="Use Internet"
                                Disabled="_isApplePlatform"
                                Color="Color.Secondary" />
                </MudStack>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RunPrediction" Class="mt-4">Predict</MudButton>
            </MudStack>
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudExpansionPanels>
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex">
                            <MudIcon Icon="@Icons.Material.Filled.Info" class="mr-3"></MudIcon>
                            <MudText>Feature Definitions</MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <strong>Seismic Moment Rate (Nm/s):</strong> Total energy release rate from seismic events. <br /><br />

                        <strong>Surface Displacement Rate (mm/yr):</strong> Horizontal/vertical ground motion observed via GPS/InSAR. <br /><br />

                        <strong>Coulomb Stress Change (Pa):</strong> Fault stress changes post-seismic activity. <br /><br />

                        <strong>Average Focal Depth (km):</strong> Typical depth of earthquakes in the region. <br /><br />

                        <strong>Fault Slip Rate (mm/yr):</strong> Long-term fault motion due to tectonic loading.
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>
            <br />
            <MudText Typo="Typo.h6" Class="mb-2">Earthquake Risk Verdict</MudText>
            <MudTextField T="string" Value="@_predictionResult" ReadOnly="true" FullWidth="true" />
            @if (_showAlert)
            {
                <MudAlert Severity="@_alertSeverity" Elevation="1" Dense="true" Class="mt-2">
                    @_alertMessage
                </MudAlert>
            }
        </MudItem>
    </MudGrid>
</MudPaper>


@code {
    private string[] _spinnerFrames = new[] { "⠋", "⠙", "⠹", "⠸", "⠼", "⠴", "⠦", "⠧", "⠇", "⠏" };
    private int _spinnerIndex = 0;
    private Timer? _spinnerTimer;
    private bool _isPredicting = false;

    private string _alertMessage = "";
    private Severity _alertSeverity = Severity.Normal;
    private bool _showAlert = false;

    private void StartSpinner()
    {
        _isPredicting = true;
        _showAlert = false;
        _predictionResult = $"{_spinnerFrames[_spinnerIndex]} Predicting...";
        _spinnerTimer = new Timer(_ =>
        {
            _spinnerIndex = (_spinnerIndex + 1) % _spinnerFrames.Length;
            _predictionResult = $"{_spinnerFrames[_spinnerIndex]} Predicting...";
            InvokeAsync(StateHasChanged);
        }, null, 0, 100);
    }

    private void StopSpinner()
    {
        _spinnerTimer?.Dispose();
        _spinnerTimer = null;
    }
    private bool _useInternet = true;
    private bool _isApplePlatform = OperatingSystem.IsIOS() || OperatingSystem.IsMacOS();
    protected override void OnInitialized()
    {
        if (_isApplePlatform)
        {
            _useInternet = true;
        }
    }
    private float _momentRate = 15.0f;
    private float _displacementRate = 35f;
    private float _stressChange = 300f;
    private float _focalDepth = 18f;
    private float _slipRate = 7.0f;
    private bool _useTrust = true;
    private string _predictionResult = "";
    private string _1 = "1";
    private string _2 = "2";
    private string _3 = "3";
    private string _4 = "4";
    private string _5 = "5";

    private async Task RunPrediction()
    {
        StartSpinner();

        try
        {
            var input = new float[]
            {
                _momentRate,
                _displacementRate,
                _stressChange,
                _focalDepth,
                _slipRate
            };

            _predictionResult = await Task.Run(() => EarthquakeModelRunner.Predict(input, _useTrust, _useInternet));

            _alertMessage = "Prediction successful.";
            _alertSeverity = Severity.Success;
            _showAlert = true;
        }
        catch (Exception ex)
        {
            _predictionResult = " ";
            _alertMessage = $"Prediction failed. {ex.Message}";
            _alertSeverity = Severity.Error;
            _showAlert = true;
        }
        finally
        {
            StopSpinner();
        }
    }
    private void ResetPrediction()
    {
        _predictionResult = "";
        _showAlert = false;
    }
    private Dictionary<string, object> _lastInputs = new();
    protected override void OnParametersSet()
    {
        CheckForInputChanges();
    }

    private void CheckForInputChanges()
    {
        var currentInputs = new Dictionary<string, object>
        {
            { "momentRate", _momentRate },
            { "displacementRate", _displacementRate },
            { "stressChange", _stressChange },
            { "focalDepth", _focalDepth },
            { "slipRate", _slipRate },
            { "useTrust", _useTrust },
            { "predictionResult", _predictionResult },
            { "1", _1 },
            { "2", _2 },
            { "3", _3 },
            { "4", _4 },
            { "5", _5 }
        };
        foreach (var kvp in currentInputs)
        {
            if (!_lastInputs.ContainsKey(kvp.Key) || !_lastInputs[kvp.Key].Equals(kvp.Value))
            {
                ResetPrediction();
                break;
            }
        }

        _lastInputs = currentInputs;
    }
}